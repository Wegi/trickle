// Generated by CoffeeScript 1.8.0
var fs, list, load_module, modpath, modules, numBoxes, path, session;

numBoxes = 0;

session = {};

$("#new-box").click(function() {
  var defaultContent;
  defaultContent = "<div class='draggable ui-widget-content' id='box-" + numBoxes + "'> <div class='module-list' id='box-content-" + numBoxes + "'> I am a new Box!<br><br> Go and add some modules.<br><br> <a id='a-" + numBoxes + "' href='#' box-id='" + numBoxes + "'><span class='glyphicon glyphicon-plus'></span></a> </div> </div>";
  $("#boxes").append(defaultContent);
  $("#box-" + numBoxes).draggable({
    snap: true
  }).resizable();
  $("div#box-content-" + numBoxes + " a#a-" + numBoxes).click(function() {
    return list("#box-content-" + $(this).attr("box-id"));
  });
  sidemenu.close();
  return numBoxes++;
});


/* Show all modules */

path = require("path");

fs = require("fs");

modpath = "./modules";

modules = [];

fs.readdir(modpath, function(err, files) {
  if (err) {
    throw err;
  }
  return modules = files;
});

list = function(boxid) {
  var content, module, _i, _len;
  content = "<ul>";
  for (_i = 0, _len = modules.length; _i < _len; _i++) {
    module = modules[_i];
    content += "<li><a class='module-single' href='#' name='" + module + "'>" + module + "</a></li>";
  }
  content += "</ul>";
  $(boxid).html(content);
  return $(".module-single").click(function() {
    return load_module($(this).attr("name"), boxid);
  });
};

load_module = function(modname, boxid) {
  var moddir;
  moddir = path.join(modpath, modname);
  return fs.readFile(path.join(moddir, "config.json"), "utf8", function(err, config) {
    var mod;
    if (err) {
      console.log("Error: " + err);
      return;
    }
    config = JSON.parse(config);
    mod = require("./" + path.join(moddir, path.basename(config.hook, path.extname(config.hook))));
    return mod(boxid, session);
  });
};
