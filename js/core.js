// Generated by CoffeeScript 1.8.0

/*
    Trickle Core
 */
var fs, gui, home_path, root, win;

root = typeof exports !== "undefined" && exports !== null ? exports : this;


/* Require modules */

fs = require("fs");


/* Global variables */

root.session = {};

gui = require("nw.gui");

win = gui.Window.get();

home_path = process.env.HOME || process.env.HOMEPATH || process.env.USERPROFILE;

if (!fs.existsSync(home_path + '/.trickle')) {
  fs.mkdirSync(home_path + '/.trickle');
}

if (!fs.existsSync(home_path + '/.trickle/session.json')) {
  fs.writeFileSync(home_path + '/.trickle/session.json', '{ }');
}

try {
  fs.readFile(home_path + '/.trickle/session.json', "utf8", function(err, data) {
    if (err) {
      return console.error(err);
    } else {
      try {
        return root.session = JSON.parse(data);
      } catch (_error) {
        return console.log("close call");
      }
    }
  });
} catch (_error) {
  console.log("gotcha buddy");
  root.session = {};
}

win.on("close", function() {
  var jsonified;
  this.hide();
  jsonified = JSON.stringify(root.session, null, 2);
  return fs.writeFile(home_path + '/.trickle/session.json', jsonified, 'utf8', function(err) {
    if (err) {
      console.error(err);
    }
    return gui.App.quit();
  });
});
