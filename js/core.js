// Generated by CoffeeScript 1.8.0

/* Require modules */
var baseZIndex, boxName, configDialogue, createBox, data, fs, getNextNum, getNumFromName, gui, home_path, init_done, list, load_conf, load_module, loaded_modules, modpath, module, modules, num, parent_id, path, selectedBox, session, value, win, _i, _len, _ref, _ref1,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

fs = require("fs");

gui = require("nw.gui");

path = require("path");


/* Core Logic Preparations */

init_done = false;

home_path = process.env.HOME || process.env.HOMEPATH || process.env.USERPROFILE;

if (!fs.existsSync(home_path + '/.trickle')) {
  fs.mkdirSync(home_path + '/.trickle');
}

if (!fs.existsSync(home_path + '/.trickle/session.json')) {
  fs.writeFileSync(home_path + '/.trickle/session.json', '{ }');
}

try {
  data = fs.readFileSync(home_path + '/.trickle/session.json', "utf8");
  session = JSON.parse(data);
} catch (_error) {
  console.log("gotcha buddy");
  session = {};
}


/* Boxes Logic */

baseZIndex = 50;

configDialogue = "#config-dialogue";

loaded_modules = {};

selectedBox = "";

if (!session.present_boxes) {
  session.present_boxes = [];
}

getNextNum = function() {
  var num;
  num = 0;
  while (__indexOf.call(session.present_boxes, num) >= 0) {
    num++;
  }
  return num;
};

createBox = function(numBoxes) {
  var box, defaultContent;
  defaultContent = "<div class='draggable ui-widget-content box' id='box-" + numBoxes + "' style='z-index: " + (baseZIndex + numBoxes) + "'>\n    <div class='box-control'>\n        <span id='box-control-button-" + numBoxes + "' class='glyphicon glyphicon-cog glyphicon-fade box-control-button'></span>\n    </div>\n    <div class='box-content' id='box-content-" + numBoxes + "'></div>\n</div>";
  $("#boxes").append(defaultContent);
  box = $("#box-" + numBoxes).draggable({
    grid: [10, 10]
  }).resizable({
    grid: 10
  }).center();
  if (init_done) {
    list("#box-content-" + numBoxes, "#box-" + numBoxes);
  }
  $("div.box-control span#box-control-button-" + numBoxes).click(function() {
    selectedBox = "#" + $(this).parent().parent().prop("id");
    console.log(selectedBox);
    if ($("#control-edit-box").css("display") === "block") {
      $(selectedBox).css("border", "1px solid #aaa");
      return $("#control-edit-box").hide("slide", {
        direction: "down"
      }, function() {
        return $("#control-standard").show("slide", {
          direction: "down"
        });
      });
    } else {
      $(selectedBox).css("border", "1px solid red");
      return $("#control-standard").hide("slide", {
        direction: "down"
      }, function() {
        return $("#control-edit-box").show("slide", {
          direction: "down"
        });
      });
    }
  });
  if (__indexOf.call(session.present_boxes, numBoxes) < 0) {
    return session.present_boxes.push(numBoxes);
  }
};

$("#new-box").click(function() {
  var num;
  num = getNextNum();
  return createBox(num);
});

modpath = "./modules";

modules = [];

fs.readdir(modpath, function(err, files) {
  if (err) {
    throw err;
  }
  return modules = files;
});

list = function(boxid, outer_id) {
  var bcolor, config, content, icon, module, name, _i, _len;
  content = "<h3 style='padding-bottom: 1em;'>Choose your module</h3>";
  content += "<ul>";
  for (_i = 0, _len = modules.length; _i < _len; _i++) {
    module = modules[_i];
    if ((module.charAt(0)) !== '.') {
      config = load_conf(path.join(modpath, module));
      content += "<li class='module-entry'><a class='module-single' href='#' name='" + module + "'";
      if (config) {
        name = config.name;
        bcolor = config.color;
        icon = path.join(modpath, module, config.icon);
      }
      if (bcolor !== "" && bcolor) {
        content += " style='background-color: " + bcolor + ";'";
      }
      content += ">";
      if (icon) {
        content += "<img class='icon' src='" + icon + "' alt='" + module + "'> ";
      }
      if (name !== "" && name) {
        content += "" + name + "</a></li>";
      } else {
        content += "" + module + "</a></li>";
      }
    }
  }
  content += "</ul>";
  $(configDialogue).lightbox_me().html(content);
  return $(".module-single").click(function() {
    return load_module($(this).attr("name"), boxid, outer_id);
  });
};

load_module = function(modname, boxid, outer_id) {
  var config, mod, moddir;
  console.log("loading " + modname + " on " + boxid + " inside of " + outer_id);
  moddir = path.join(modpath, modname);
  config = load_conf(moddir);
  if (!loaded_modules[outer_id]) {
    loaded_modules[outer_id] = [];
  }
  if (__indexOf.call(loaded_modules[outer_id], modname) < 0) {
    loaded_modules[outer_id].push(modname);
  }
  if (config) {
    mod = require("./" + path.join(moddir, path.basename(config.hook, path.extname(config.hook))));
    return mod(boxid, configDialogue, session);
  }
};

load_conf = function(moddir) {
  var config, e;
  try {
    config = fs.readFileSync(path.join(moddir, "config.json"), "utf8");
  } catch (_error) {
    e = _error;
    config = null;
  }
  return JSON.parse(config);
};

$.fn.center = function() {
  this.css("position", "absolute");
  this.css("top", Math.max(0, (($(window).height() - $(this).outerHeight()) / 2) + $(window).scrollTop()) + "px");
  this.css("left", Math.max(0, (($(window).width() - $(this).outerWidth()) / 2) + $(window).scrollLeft()) + "px");
  return this;
};


/* Core Logic (Startup and Close) */

getNumFromName = function(name) {
  var pattern;
  pattern = /^#.*-(\d+)$/;
  return Number(name.match(pattern)[1]);
};

_ref = session.boxes;
for (boxName in _ref) {
  value = _ref[boxName];
  parent_id = value.parent_id;
  num = getNumFromName(parent_id);
  createBox(num);
  $(parent_id).offset(value.position);
  $(boxName).html(value.content);
  $(parent_id).css('heigth', value.size.height);
  $(parent_id).css('width', value.size.width);
  loaded_modules[parent_id] = value.loaded_modules;
  if (loaded_modules[parent_id]) {
    _ref1 = loaded_modules[parent_id];
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      module = _ref1[_i];
      load_module(module, boxName, parent_id);
    }
  }
}

init_done = true;

win = gui.Window.get();

win.on("close", function() {
  var jsonified;
  this.hide();
  if (!session.boxes) {
    session["boxes"] = {};
  }
  $(".box-content").each(function(index) {
    var id;
    id = '#' + $(this).prop("id");
    parent_id = '#' + $(id).parent().prop("id");
    if (!session.boxes["" + id]) {
      session.boxes["" + id] = {};
    }
    session.boxes["" + id].parent_id = parent_id;
    session.boxes["" + id].position = $(parent_id).offset();
    session.boxes["" + id].content = $(id).html();
    session.boxes["" + id].size = {
      "height": $(parent_id).height(),
      "width": $(parent_id).width()
    };
    if (loaded_modules[parent_id]) {
      return session.boxes[id].loaded_modules = loaded_modules[parent_id];
    }
  });
  jsonified = JSON.stringify(session, null, 4);
  fs.writeFileSync(home_path + '/.trickle/session.json', jsonified, 'utf8');
  return gui.App.quit();
});
